name: Deploy to EC2

on:
  push:
    branches: [ "main" ]  # main ë¸Œëœì¹˜ì— push ì‹œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      FRONT_KEY: '[front]'
      BACK_KEY: '[back]'

    steps:
      # âœ… 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # âœ… 2ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      - name: Build frontend
        if: contains(github.event.head_commit.message, env.FRONT_KEY)
        run: |
          echo "ğŸ§± Building frontend..."
          cd frontend
          npm install
          npm run build
          tar -czf build.tar.gz build
          mv build.tar.gz $GITHUB_WORKSPACE/build.tar.gz
          echo "âœ… Frontend build complete!"

      # âœ… 3ï¸âƒ£ ìë°” ì„¸íŒ… (ë°±ì—”ë“œ ë¹Œë“œìš©)
      - name: Setup Java for backend
        if: contains(github.event.head_commit.message, env.BACK_KEY)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # âœ… 4ï¸âƒ£ ë°±ì—”ë“œ ë¹Œë“œ
      - name: Build backend
        if: contains(github.event.head_commit.message, env.BACK_KEY)
        run: |
          echo "âš™ï¸ Building backend..."
          cd backend
          chmod +x gradlew
          ./gradlew clean build -x test
          echo "ğŸ“¦ Build output í™•ì¸:"
          ls -al build/libs
          cp build/libs/*SNAPSHOT.jar ../app.jar
          echo "âœ… Backend build complete!"

      # âœ… 5ï¸âƒ£ EC2ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ ì „ì†¡
      - name: Upload frontend build to EC2
        if: contains(github.event.head_commit.message, env.FRONT_KEY)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "build.tar.gz"
          target: "/home/ubuntu"

      # âœ… 6ï¸âƒ£ EC2ë¡œ ë°±ì—”ë“œ JAR íŒŒì¼ ì „ì†¡
      - name: Upload backend jar to EC2
        if: contains(github.event.head_commit.message, env.BACK_KEY)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "app.jar"
          target: "/home/ubuntu"

      # âœ… 7ï¸âƒ£ EC2 ë‚´ë¶€ì—ì„œ ë°°í¬ ëª…ë ¹ ì‹¤í–‰
      - name: Run deployment commands on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment process on EC2..."

            # ğŸ§± í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
            if [[ "${{ github.event.head_commit.message }}" == *"[front]"* ]]; then
              echo "ğŸ§© Frontend update detected."
              if [ -f "/home/ubuntu/build.tar.gz" ]; then
                sudo rm -rf /var/www/html/*
                sudo tar -xzf /home/ubuntu/build.tar.gz -C /var/www/html --strip-components=1
                sudo chown -R www-data:www-data /var/www/html
                sudo chmod -R 755 /var/www/html
                sudo systemctl restart nginx
                echo "âœ… Frontend updated successfully!"
              else
                echo "âš ï¸ build.tar.gz not found, skipping frontend deploy."
              fi
            fi

            # âš™ï¸ ë°±ì—”ë“œ ë°°í¬
            if [[ "${{ github.event.head_commit.message }}" == *"[back]"* ]]; then
              echo "ğŸ§© Backend update detected."
              if [ -f "/home/ubuntu/app.jar" ]; then
                sudo systemctl stop spring || true
                sudo mv /home/ubuntu/app.jar /home/ubuntu/backend/app.jar
                sudo systemctl start spring
                echo "âœ… Backend restarted successfully!"
              else
                echo "âš ï¸ app.jar not found, skipping backend deploy."
              fi
            fi
