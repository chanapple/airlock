name: Deploy to EC2

on:
  push:
    branches: [ "main" ]  # main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # âœ… 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # âœ… 2ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      - name: Build frontend
        if: contains(github.event.head_commit.message, '[front]')
        run: |
          echo "ğŸ§± Building frontend..."
          cd frontend
          npm install
          npm run build
          tar -czf build.tar.gz build
          mv build.tar.gz ../build.tar.gz
          echo "âœ… Frontend build complete!"

      # âœ… 3ï¸âƒ£ ë°±ì—”ë“œ ë¹Œë“œ
      - name: Setup Java for backend
        if: contains(github.event.head_commit.message, '[back]')
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build backend
        if: contains(github.event.head_commit.message, '[back]')
        run: |
          echo "âš™ï¸ Building backend..."
          cd backend
          ./gradlew clean build -x test
          cp build/libs/*.jar ../app.jar
          echo "âœ… Backend build complete!"

      # âœ… 4ï¸âƒ£ EC2ë¡œ íŒŒì¼ ì „ì†¡
      - name: Upload files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}   # ğŸ‘ˆ ì´ë¦„ ìˆ˜ì •!
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "app.jar,build.tar.gz"
          target: "/home/ubuntu"
          port: 22

      # âœ… 5ï¸âƒ£ EC2 ë‚´ì—ì„œ ë°°í¬ ëª…ë ¹ ì‹¤í–‰
      - name: Run deployment commands on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}   # ğŸ‘ˆ ë™ì¼í•˜ê²Œ ìˆ˜ì •
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment process on EC2..."

            if [[ "${GITHUB_HEAD_COMMIT_MESSAGE}" == *"[front]"* ]]; then
              echo "ğŸ§© Frontend update detected."
              if [ -f "build.tar.gz" ]; then
                sudo rm -rf /var/www/html/*
                sudo tar -xzf build.tar.gz -C /var/www/html
                echo "âœ… Frontend updated successfully!"
              else
                echo "âš ï¸ build.tar.gz not found, skipping frontend deploy."
              fi
            fi

            if [[ "${GITHUB_HEAD_COMMIT_MESSAGE}" == *"[back]"* ]]; then
              echo "ğŸ§© Backend update detected."
              if [ -f "app.jar" ]; then
                sudo systemctl stop spring || true
                mv app.jar /home/ubuntu/backend/app.jar
                sudo systemctl start spring
                echo "âœ… Backend restarted successfully!"
              else
                echo "âš ï¸ app.jar not found, skipping backend deploy."
              fi
            fi
